
<!DOCTYPE html>
<html lang="zh-MY">
<head>
  <meta charset="UTF-8" />
  <title>Weecan Invoice</title>
  <style>
    :root {
      --primary: #f1c40f;       /* ä¸»é»„ */
      --primary-dark: #d4ac0d;  /* æ·±é»„ */
      --success: #27ae60;
      --warning: #e67e22;
      --info: #f39c12;          /* æ©™é»„ä»£æ›¿ info */
      --bg: #fdfaf3;            /* èƒŒæ™¯æµ…ç±³è‰² */
      --card-bg: #ffffff;
      --text-main: #2c3e50;
      --text-muted: #7f8c8d;
      --radius: 14px;
    }
    
    body {
      font-family: "Segoe UI", "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* é¡¶éƒ¨å¯¼èˆªæ¡ */
    header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header button {
      background: var(--primary);
      border: none;
      padding: 8px 16px;
      color: white;
      font-size: 14px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.3s;
    }
    header button:hover {
      background: var(--primary-dark);
    }
    
    /* ä¸»å®¹å™¨ */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
    }
    @media (min-width: 900px) {
      main { flex-direction: row; }
    }
    
    .section {
      flex: 1;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      padding: 24px;
      overflow-y: auto;
    }
    .section h3, .section h4 {
      margin-top: 0;
      color: var(--text-main);
    }
    
    /* äº§å“æŒ‰é’®ç»„ */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .product-button {
      padding: 12px 18px;
      font-size: 15px;
      border: none;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--info), var(--primary-dark));
      color: white;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    .product-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }
    .product-button.active {
      background: linear-gradient(135deg, var(--success), #219150) !important;
      border: 2px solid #49a97f;
    }
    
    /* è‡ªå®šä¹‰äº§å“è¾“å…¥ */
    #customProductInput {
      padding: 12px 18px;
      font-size: 15px;
      border: 2px dashed var(--primary);
      border-radius: var(--radius);
      background: #fff;
      color: var(--text-main);
      min-width: 140px;
      text-align: center;
    }
    #customProductInput:focus {
      outline: none;
      border-color: var(--primary-dark);
      background: #fff9e6; /* æµ…é»„ */
    }
    
    /* è¾“å…¥æ¡† */
    input[type="text"], input[type="number"] {
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccd;
      border-radius: var(--radius);
      width: 100%;
      box-sizing: border-box;
    }
    
    /* è¡¨æ ¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #fdf2c5; /* æµ…é»„è¡¨å¤´ */
      font-weight: 600;
    }
    
    /* æŒ‰é’®é€šç”¨ */
    button {
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      padding: 10px 16px;
      font-size: 14px;
      transition: transform 0.15s, box-shadow 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    #submitButton {
      background: linear-gradient(135deg, var(--success), #219150);
      color: white;
    }
    
    /* Toast */
    #toast {
      visibility: hidden;
      min-width: 200px;
      background: var(--success);
      color: #fff;
      text-align: center;
      border-radius: var(--radius);
      padding: 12px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
    }
    
    /* Loading é®ç½© */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(3px);
    }
    #loadingOverlay div {
      background: var(--card-bg);
      padding: 20px 30px;
      border-radius: var(--radius);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* å¼¹å‡ºè¾“å…¥é¢æ¿ */
    #popupInput {
      position: absolute;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: none;
      z-index: 500;
    }
    #popupInput h5 {
      margin: 4px 0;
      font-size: 14px;
      color: var(--text-main);
    }
    #popupInput input {
      width: 100px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§¾ Purchase </h1>
    <div class="header-actions">
      <button id="backBtn">â¬…ï¸ Back</button>
      <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
    </div>
  </header>


  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      // æ²¡æœ‰ç™»å½•ï¼Œç›´æ¥è·³è½¬åˆ° login.html
      window.location.href = "index.html";
    }
  </script>

  <main>
    <!-- å·¦è¾¹è¾“å…¥åŒº -->
    <div class="section">
      <h3>å®¢æˆ·ä¿¡æ¯</h3>
      <input type="text" id="customerName" placeholder="å®¢æˆ·åå­— (å¿…å¡«)" />

      <h4>ğŸˆ Musang</h4>
      <div class="button-group">
        <button class="product-button" data-name="Musang AM">AM</button>
        <button class="product-button" data-name="Musang ABM">ABM</button>
        <button class="product-button" data-name="Musang BM">BM</button>
        <button class="product-button" data-name="Musang CM">CM</button>
        <button class="product-button" data-name="Musang CCM">CCM</button>
        <button class="product-button" data-name="Musang CCCM">CCCM</button>
      </div>

      <h4>ğŸŒ‘ Black Thorn</h4>
      <div class="button-group">
        <button class="product-button" data-name="BTA">BTA</button>
        <button class="product-button" data-name="BTB">BTB</button>
        <button class="product-button" data-name="BTC">BTC</button>
        <button class="product-button" data-name="BTCC">BTCC</button>
      </div>

      <h4>ğŸŒ• D24</h4>
      <div class="button-group">
        <button class="product-button" data-name="D24A">D24A</button>
        <button class="product-button" data-name="D24B">D24B</button>
        <button class="product-button" data-name="D24C">D24C</button>
      </div>

      <h4>ğŸƒ å…¶ä»–å“ç§</h4>
      <div class="button-group">
        <button class="product-button" data-name="Kampung">Kampung</button>
        <button class="product-button" data-name="KC">KC</button>
        <button class="product-button" data-name="Kahwin">KW</button>
        <input type="text" id="customProductInput" placeholder="è¾“å…¥è‡ªå®šä¹‰äº§å“åç§°" />
      </div>
 
    </div>

    <!-- å³è¾¹é¢„è§ˆåŒº -->
    <div class="section">
      <h3>ğŸ“‹ Invoice Overview</h3>
      <div class="invoice-box">
        <table>
          <thead>
            <tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="invoiceItems"></tbody>
        </table>
        <p><strong>æ€»è®¡ï¼š</strong>RM <span id="totalAmount">0.00</span></p>
      </div>
      <div style="margin-top:15px;text-align:right;">
        <button type="button" id="submitButton" style="display:none;">ğŸ“¤ æäº¤åˆ° Airtable</button>
      </div>
    </div>
  </main>

  <!-- å¼¹å‡ºè¾“å…¥é¢æ¿ -->
  <div id="popupInput">
    <div><b id="popupProductName"></b></div>
    <h5>é‡é‡ï¼ˆKGï¼‰</h5>
    <input type="number" id="popupWeight" placeholder="é‡é‡" />
    <h5>å•ä»·ï¼ˆRMï¼‰</h5>
    <input type="number" id="popupPrice" placeholder="å•ä»·" />
    <button type="button" onclick="confirmPopup()">ç¡®å®š</button>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Loading é®ç½© -->
  <div id="loadingOverlay">
    <div>
      <div class="spinner"></div>
      <span id="loadingText">æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...</span>
    </div>
  </div>

  <script src="auth.js"></script>

  <script>
  const API_URL = "https://syve-dinvoice-system.vercel.app/api/token";
  const items = [];
  window.receiptNo = generateReceiptNo();

  function generateReceiptNo() {
    const now = new Date();
    const ymd = now.toISOString().slice(2,10).replace(/-/g,"");
    const rand = Math.floor(1000 + Math.random()*9000);
    return `RCPT-${ymd}-${rand}`;
  }

  let currentProduct = null;

  function selectProduct(name, btn) {
    currentProduct = name;
    document.getElementById('popupProductName').innerText = "ğŸ§º " + name;

    const rect = btn.getBoundingClientRect();
    const popup = document.getElementById('popupInput');

    popup.style.top = (window.scrollY + rect.bottom + 8) + "px";
    popup.style.left = (window.scrollX + rect.left) + "px";
    popup.style.display = "block";
  }

  function confirmPopup() {
    const w = parseFloat(document.getElementById('popupWeight').value);
    const p = parseFloat(document.getElementById('popupPrice').value);
    const prod = currentProduct;

    if(prod && !isNaN(w) && !isNaN(p)) {
      items.push({product:prod, weight:w, price:p});
      updateInvoice();
      showToast("âœ… æ·»åŠ æˆåŠŸ");
    } else {
      alert("è¯·å¡«å†™é‡é‡å’Œå•ä»·ï¼");
      return;
    }

    document.getElementById('popupWeight').value = "";
    document.getElementById('popupPrice').value = "";
    document.getElementById('popupInput').style.display = "none";
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.style.visibility = "visible";
    setTimeout(() => {
      toast.style.visibility = "hidden";
    }, 2000);
  }

  function updateInvoice() {
    const tbody = document.getElementById('invoiceItems'); tbody.innerHTML='';
    let total=0;
    items.forEach((it,i)=>{
      const sub=it.weight*it.price; total+=sub;
      tbody.insertAdjacentHTML('beforeend',
        `<tr><td>${it.product}</td><td><input type="number" value="${it.weight}" onchange="editItem(${i},'weight',this.value)"></td>` +
        `<td><input type="number" value="${it.price.toFixed(2)}" onchange="editItem(${i},'price',this.value)"></td>`+
        `<td>${sub.toFixed(2)}</td><td><button type="button" onclick="deleteItem(${i})">âŒ åˆ é™¤</button></td></tr>`);
    });
    document.getElementById('totalAmount').innerText = total.toFixed(2);
    document.getElementById('submitButton').style.display = items.length ? 'inline-block':'none';
  }

  function deleteItem(i){ if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€é¡¹å—ï¼Ÿ')){ items.splice(i,1); updateInvoice(); }}
  function editItem(i,f,v){ const n=parseFloat(v); if(!isNaN(n)){ items[i][f]=n; updateInvoice(); }}

  function printReceipt() {
    const cust = document.getElementById('customerName').value.trim() || 'N/A';
    const now = new Date();
    const timeStr = now.toLocaleString('zh-MY');
    const no = window.receiptNo || "N/A";
  
    let itemsHTML = '';
    let tot = 0;
  
    items.forEach(it => {
      const s = it.weight * it.price;
      tot += s;
      itemsHTML += `
        <tr>
          <td>${it.product}</td>
          <td>${it.weight.toFixed(2)}</td>
          <td>RM ${it.price.toFixed(2)}</td>
          <td>RM ${s.toFixed(2)}</td>
        </tr>`;
    });
  
    const win = window.open("", "_blank");
    win.document.write(`
      <html>
        <head>
          <meta charset="UTF-8"/>
          <title>Receipt ${no}</title>
          <style>
            body { font-family: Arial, sans-serif; font-size: 12pt; padding:20px; }
            .header { text-align:center; font-size: 18pt; font-weight: bold; margin-bottom: 10px; }
            table { width:100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #000; padding: 6px; text-align: center; }
            th { background: #f5f5f5; }
            tfoot td { font-weight: bold; background: #f5f5f5; }
            .btn { margin: 10px; padding: 8px 16px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
            .btn:hover { background:#2c80b4; }
            /* æ‰“å°æ—¶éšè—æŒ‰é’® */
            @media print {
              .no-print { display: none !important; }
            }
          </style>
        </head>
        <body>
          <div class="header">Purchase Receipt</div>
          <p><b>å®¢æˆ·ï¼š</b>${cust}</p>
          <p><b>ç¼–å·ï¼š</b>${no}</p>
          <p><b>æ—¶é—´ï¼š</b>${timeStr}</p>
          <table>
            <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th></tr></thead>
            <tbody>${itemsHTML}</tbody>
            <tfoot><tr><td colspan="3">æ€»è®¡</td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
          </table>
          <div style="text-align:center;margin-top:10px">â€ Thank You â€</div>
  
          <!-- åº•éƒ¨æŒ‰é’® (ä¸ä¼šè¢«æ‰“å°) -->
          <div class="no-print" style="text-align:center; margin-top:30px;">
            <button class="btn" onclick="window.print()">ğŸ–¨ æ‰“å° / å­˜ PDF</button>
            <button class="btn" onclick="window.opener.location.href='main.html'; window.close();">â¬… è¿”å›</button>
          </div>
        </body>
      </html>
    `);
    win.document.close();
  }


  let isSubmitting = false;
  async function submitToAirtable() {
    if (isSubmitting) return;
    isSubmitting = true;
    document.getElementById('submitButton').disabled = true;
  
    const cust = document.getElementById('customerName').value.trim();
    if (!cust || !items.length) {
      alert('è¯·å¡«å†™å®¢æˆ·åå­—å¹¶è‡³å°‘æ·»åŠ ä¸€ä¸ªå•†å“ï¼');
      isSubmitting = false;
      document.getElementById('submitButton').disabled = false;
      return;
    }

    showLoading("æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...");
  
    try {
      for (const [i, it] of items.entries()) {
        const total = it.weight * it.price;
        const payload = {
          fields: {
            "Receipt Number": window.receiptNo,
            "Customer Name": cust,
            "Product Name": it.product,
            "Unit Price": it.price,
            "Weight": it.weight,
            "Total Price": total
          }
        };
  
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const errMsg = await res.text();
          alert(`âŒ ç¬¬ ${i + 1} é¡¹æäº¤å¤±è´¥ï¼š${errMsg}`);
          hideLoading();
          isSubmitting = false;
          document.getElementById('submitButton').disabled = false;
          return;
        }
      }

      document.getElementById("loadingText").innerText = "âœ… æäº¤æˆåŠŸï¼Œè¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­æ“ä½œæ‰“å°";
      printReceipt();
      items.length = 0;
      updateInvoice();
  
    } catch (error) {
      alert(`ğŸš¨ æäº¤å¼‚å¸¸: ${error.message}`);
      hideLoading();
    } finally {
      isSubmitting = false;
      document.getElementById('submitButton').disabled = false;
    }
  }

  function showLoading(msg="æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...") {
    document.getElementById("loadingText").innerText = msg;
    document.getElementById("loadingOverlay").style.display = "flex";
  }
  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  window.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.product-button').forEach(b=>{
        b.addEventListener('click',()=>selectProduct(b.dataset.name, b));
      });
      document.getElementById('submitButton').addEventListener('click',submitToAirtable);
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'main.html';
      });

      document.getElementById('customProductInput').addEventListener('input',e=>{
        const v=e.target.value.trim();
        if(v){
          currentProduct = v;
          document.getElementById('popupProductName').innerText = "ğŸ§º " + v;
          const input = e.target;
          const rect = input.getBoundingClientRect();
          const popup = document.getElementById('popupInput');
          popup.style.top = (window.scrollY + rect.bottom + 8) + "px";
          popup.style.left = (window.scrollX + rect.left) + "px";
          popup.style.display = "block";
        } else {
          document.getElementById('popupInput').style.display="none";
        }
      });
    
      // ğŸŸ¡ åŠ åœ¨è¿™é‡Œ
      document.addEventListener('click', (e) => {
        const popup = document.getElementById('popupInput');
        if (!popup.contains(e.target) && !e.target.classList.contains('product-button') && e.target.id !== 'customProductInput') {
          popup.style.display = "none";
        }
      });
    });

  </script>
</body>
</html>
