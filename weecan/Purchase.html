<!DOCTYPE html>
<html lang="zh-MY">
<head>
  <meta charset="UTF-8" />
  <title>Weecan Invoice</title>
  <style>
    :root {
      --primary:#f1c40f; --primary-dark:#d4ac0d;
      --success:#27ae60; --warning:#e67e22; --info:#f39c12;
      --bg:#fdfaf3; --card-bg:#ffffff; --text-main:#2c3e50;
      --radius:14px;
    }
    body{font-family:"Segoe UI","Inter",sans-serif;background:var(--bg);margin:0;color:var(--text-main);display:flex;flex-direction:column;min-height:100vh;}
    header{background:var(--card-bg);box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;}
    header h1{font-size:20px;margin:0;display:flex;align-items:center;gap:8px;}
    header button{background:var(--primary);border:none;padding:8px 16px;color:white;font-size:14px;border-radius:var(--radius);cursor:pointer;}
    header button:hover{background:var(--primary-dark);}
    main{flex:1;display:flex;flex-direction:column;padding:20px;gap:20px;}
    @media(min-width:900px){main{flex-direction:row;}}
    .section{flex:1;background:var(--card-bg);border-radius:var(--radius);box-shadow:0 3px 12px rgba(0,0,0,0.06);padding:24px;overflow-y:auto;}
    .button-group{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
    .product-button{padding:12px 18px;font-size:15px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--info),var(--primary-dark));color:white;cursor:pointer;}
    .product-button:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,0.12);}
    #customProductInput{padding:12px 18px;font-size:15px;border:2px dashed var(--primary);border-radius:var(--radius);background:#fff;min-width:140px;text-align:center;}
    input[type="text"],input[type="number"]{padding:10px;font-size:15px;border:1px solid #ccd;border-radius:var(--radius);width:100%;box-sizing:border-box;}
    table{width:100%;border-collapse:collapse;margin-top:15px;}
    th,td{border:1px solid #ddd;padding:10px;text-align:center;}
    th{background:#fdf2c5;font-weight:600;}
    #toast{visibility:hidden;min-width:200px;background:var(--success);color:#fff;text-align:center;border-radius:var(--radius);padding:12px;position:fixed;z-index:1000;left:50%;bottom:30px;transform:translateX(-50%);}
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:2000;}
    #loadingOverlay div{background:var(--card-bg);padding:20px 30px;border-radius:var(--radius);font-size:16px;display:flex;align-items:center;gap:10px;}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    /* å¼¹çª— */
    #popupInput{position:absolute;background:#fff;border:1px solid #ddd;border-radius:var(--radius);padding:16px;box-shadow:0 4px 10px rgba(0,0,0,0.15);display:none;z-index:999;min-width:220px;}
    #popupInput b{display:block;margin-bottom:14px;font-weight:600;}
    #popupInput input{display:block;width:100%;margin:12px 0;padding:10px;border:1px solid #ccc;border-radius:var(--radius);font-size:15px;box-sizing:border-box;}
    #popupInput button {background: var(--primary);border: none;padding: 12px;color: white;font-size: 15px;border-radius: var(--radius);cursor: pointer;margin-top: 12px;width: 100%;}
    #popupInput button:hover {background: var(--primary-dark);}
    #submitButton {background: linear-gradient(135deg,var(--success),#219150);border: none;padding: 10px 16px;color: white;font-size: 15px;border-radius: var(--radius);cursor: pointer;}
    #submitButton:hover {background:#1e7c43;}
    @media print {.no-print, header, #submitButton, #toast, #loadingOverlay {display:none!important;}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§¾ Purchase</h1>
    <div class="header-actions">
      <button id="backBtn">â¬…ï¸ Back</button>
      <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <main id="mainContent">
    <!-- å·¦è¾¹è¾“å…¥åŒº -->
    <div class="section">
      <h3>å®¢æˆ·ä¿¡æ¯</h3>
      <input type="text" id="customerName" placeholder="å®¢æˆ·åå­— (å¿…å¡«)" />

      <h4>ğŸˆ Musang</h4>
      <div class="button-group">
        <button class="product-button" data-name="Musang AM">AM</button>
        <button class="product-button" data-name="Musang ABM">ABM</button>
        <button class="product-button" data-name="Musang BM">BM</button>
        <button class="product-button" data-name="Musang CM">CM</button>
        <button class="product-button" data-name="Musang CCM">CCM</button>
        <button class="product-button" data-name="Musang CCCM">CCCM</button>
      </div>

      <h4>ğŸŒ‘ Black Thorn</h4>
      <div class="button-group">
        <button class="product-button" data-name="BTA">BTA</button>
        <button class="product-button" data-name="BTB">BTB</button>
        <button class="product-button" data-name="BTC">BTC</button>
        <button class="product-button" data-name="BTCC">BTCC</button>
      </div>

      <h4>ğŸŒ• D24</h4>
      <div class="button-group">
        <button class="product-button" data-name="D24A">D24A</button>
        <button class="product-button" data-name="D24B">D24B</button>
        <button class="product-button" data-name="D24C">D24C</button>
      </div>

      <h4>ğŸƒ å…¶ä»–å“ç§</h4>
      <div class="button-group">
        <button class="product-button" data-name="Kampung">Kampung</button>
        <button class="product-button" data-name="KC">KC</button>
        <button class="product-button" data-name="Kahwin">KW</button>
        <input type="text" id="customProductInput" placeholder="è¾“å…¥è‡ªå®šä¹‰äº§å“åç§°" />
      </div>
    </div>

    <!-- å³è¾¹é¢„è§ˆåŒº -->
    <div class="section">
      <h3>ğŸ“‹ Invoice Overview</h3>
      <table>
        <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="invoiceItems"></tbody>
      </table>
      <p><strong>æ€»è®¡ï¼š</strong>RM <span id="totalAmount">0.00</span></p>
      <div style="text-align:right;"><button id="submitButton" style="display:none;">ğŸ“¤ æäº¤åˆ° Airtable</button></div>
    </div>
  </main>

  <!-- å¼¹å‡ºè¾“å…¥ -->
  <div id="popupInput">
    <b id="popupProductName"></b>
    <input type="number" id="popupWeight" placeholder="é‡é‡(KG)" />
    <input type="number" id="popupPrice" placeholder="å•ä»·(RM)" />
    <button onclick="confirmPopup()">ç¡®å®š</button>
  </div>

  <div id="toast"></div>
  <div id="loadingOverlay"><div><div class="spinner"></div><span id="loadingText">æ­£åœ¨æäº¤...</span></div></div>

<script>
const API_URL="https://syve-dinvoice-system.vercel.app/api/token";
const items=[];
window.receiptNo=generateReceiptNo();
function generateReceiptNo(){
  const now=new Date();
  const ymd=now.toISOString().slice(2,10).replace(/-/g,"");
  const rand=Math.floor(1000+Math.random()*9000);
  return `RCPT-${ymd}-${rand}`;
}

let currentProduct=null;
function selectProduct(name,btn){
  currentProduct=name;
  document.getElementById('popupProductName').innerText="ğŸ§º "+name;
  const rect=btn.getBoundingClientRect();
  const popup=document.getElementById('popupInput');
  popup.style.top=(window.scrollY+rect.bottom+8)+"px";
  popup.style.left=(window.scrollX+rect.left)+"px";
  popup.style.display="block";
}
function confirmPopup(){
  const w=parseFloat(document.getElementById('popupWeight').value);
  const p=parseFloat(document.getElementById('popupPrice').value);
  if(currentProduct&&!isNaN(w)&&!isNaN(p)){
    items.push({product:currentProduct,weight:w,price:p});
    updateInvoice();showToast("âœ… æ·»åŠ æˆåŠŸ");
    document.getElementById('customProductInput').value="";
  }else{alert("è¯·å¡«å†™é‡é‡å’Œå•ä»·ï¼");return;}
  document.getElementById('popupWeight').value="";document.getElementById('popupPrice').value="";
  document.getElementById('popupInput').style.display="none";
}
function updateInvoice(){
  const tbody=document.getElementById('invoiceItems');tbody.innerHTML='';
  let total=0;
  items.forEach((it,i)=>{
    const sub=it.weight*it.price;total+=sub;
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${it.product}</td>
      <td><input type="number" value="${it.weight}" onchange="editItem(${i},'weight',this.value)"></td>
      <td><input type="number" value="${it.price.toFixed(2)}" onchange="editItem(${i},'price',this.value)"></td>
      <td>${sub.toFixed(2)}</td>
      <td><button onclick="deleteItem(${i})">âŒ åˆ é™¤</button></td></tr>`
    );
  });
  document.getElementById('totalAmount').innerText=total.toFixed(2);
  document.getElementById('submitButton').style.display=items.length?'inline-block':'none';
}
function deleteItem(i){if(confirm('ç¡®å®šåˆ é™¤?')){items.splice(i,1);updateInvoice();}}
function editItem(i,f,v){const n=parseFloat(v);if(!isNaN(n)){items[i][f]=n;updateInvoice();}}
function showToast(msg){const t=document.getElementById("toast");t.innerText=msg;t.style.visibility="visible";setTimeout(()=>t.style.visibility="hidden",2000);}
function showLoading(msg="..."){document.getElementById("loadingText").innerText=msg;document.getElementById("loadingOverlay").style.display="flex";}
function hideLoading(){document.getElementById("loadingOverlay").style.display="none";}

document.addEventListener('click',(e)=>{
  const popup=document.getElementById('popupInput');const custom=document.getElementById('customProductInput');
  if(popup.style.display==="block" && !popup.contains(e.target) && !e.target.classList.contains('product-button') && e.target!==custom){
    popup.style.display="none";document.getElementById('popupWeight').value="";document.getElementById('popupPrice').value="";
  }
});

// âœ… æ”¶æ®é¢„è§ˆ + A4/å°ç¥¨æ‰“å°
function showReceiptPage(cust, items){
  const now=new Date();
  const timeStr=now.toLocaleString('zh-MY');
  const no=window.receiptNo;
  let itemsHTML='',tot=0;

  items.forEach(it=>{
    const s=it.weight*it.price;
    tot+=s;
    itemsHTML+=`<tr>
      <td>${it.product}</td>
      <td>${it.weight.toFixed(2)}</td>
      <td>RM ${it.price.toFixed(2)}</td>
      <td>RM ${s.toFixed(2)}</td>
    </tr>`;
  });

  // âœ… æŠŠæ”¶æ®å’ŒæŒ‰é’®éƒ½åŒ…åœ¨ä¸€ä¸ª receipt-container é‡Œ
  document.getElementById("mainContent").innerHTML=`
    <div class="receipt-container" style="max-width:420px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:20px;">
      
      <div class="receipt-box" style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);width:100%;">
        <h2 style="text-align:center;margin-bottom:15px;">Purchase Receipt</h2>
        <p><b>å®¢æˆ·ï¼š</b>${cust}</p>
        <p><b>ç¼–å·ï¼š</b>${no}</p>
        <p><b>æ—¶é—´ï¼š</b>${timeStr}</p>
        <table style="width:100%;border-collapse:collapse;margin-top:10px;">
          <thead>
            <tr style="background:#fdf2c5;">
              <th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th>
            </tr>
          </thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot>
            <tr><td colspan="3" style="font-weight:bold;">æ€»è®¡</td><td>RM ${tot.toFixed(2)}</td></tr>
          </tfoot>
        </table>
        <div style="text-align:center;margin-top:20px;">â€ Thank You â€</div>
      </div>

      <div class="action-buttons no-print" style="display:flex;justify-content:center;gap:12px;width:100%;">
        <button onclick="setPaper('a4')" 
          style="flex:1;padding:12px;border-radius:8px;background:#3498db;color:#fff;border:none;font-size:15px;">
          ğŸ–¨ æ‰“å° A4
        </button>
        <button onclick="setPaper('receipt')" 
          style="flex:1;padding:12px;border-radius:8px;background:#3498db;color:#fff;border:none;font-size:15px;">
          ğŸ§¾ æ‰“å°å°ç¥¨
        </button>
        <button onclick="window.location.reload()" 
          style="flex:1;padding:12px;border-radius:8px;background:#e67e22;color:#fff;border:none;font-size:15px;">
          â¬… è¿”å›
        </button>
      </div>
    </div>`;
}



function setPaper(type){
  if(type==='a4'){
    const style=`@page { size: A4 portrait; margin: 15mm; }
      body, html {
        margin:0;
        padding:0;
        height:auto !important;
        background:#fff !important;
      }
      main { display:block !important; padding:0 !important; }
      .receipt-container {
        width:100% !important;
        max-width:100% !important;
        margin:0 auto !important;
        box-shadow:none !important;
        border:none !important;
        padding:0 !important;
      }
      table {width:100%;border-collapse:collapse;margin-top:10px;}
      th,td {border:1px solid #000;padding:6px;text-align:center;}
      tfoot td {font-weight:bold;border-top:2px solid #000;}`; 
    applyPrintStyle(style);
  } else {
    const style=`@page { size: 58mm auto; margin:0; }
      body { margin:0; }
      .receipt-container {
        width:58mm!important;
        max-width:58mm!important;
        font-family:monospace;
        font-size:10pt;
        box-shadow:none!important;
        border:none!important;
        padding:4px!important;
      }
      table {width:100%;font-size:9pt;border-collapse:collapse;}
      th,td {padding:2px 0;text-align:left;}
      tfoot td {border-top:1px dashed #000;font-weight:bold;}`; 
    applyPrintStyle(style);
  }
  window.print();
}



function applyPrintStyle(css){
  let s=document.getElementById('printStyle');
  if(!s){
    s=document.createElement('style');
    s.id='printStyle';
    document.head.appendChild(s);
  }
  s.innerHTML=css+`@media print{.no-print{display:none!important;}}`;
}

function wrapTicket(){
  if(!document.querySelector('.ticket')){
    document.body.innerHTML='<div class="ticket">'+document.body.innerHTML+'</div>';
  }
}

let isSubmitting=false;
async function submitToAirtable(){
  if(isSubmitting)return;isSubmitting=true;document.getElementById('submitButton').disabled=true;
  const cust=document.getElementById('customerName').value.trim();
  if(!cust||!items.length){alert('è¯·å¡«å†™å®¢æˆ·åå­—å¹¶è‡³å°‘æ·»åŠ ä¸€é¡¹');isSubmitting=false;document.getElementById('submitButton').disabled=false;return;}
  showLoading("æ­£åœ¨æäº¤...");
  try{
    for(const it of items){
      const payload={fields:{"Receipt Number":window.receiptNo,"Customer Name":cust,"Product Name":it.product,"Unit Price":it.price,"Weight":it.weight,"Total Price":it.weight*it.price}};
      const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!res.ok){alert("âŒ æäº¤å¤±è´¥");hideLoading();return;}
    }
    hideLoading();showReceiptPage(cust,items);
  }catch(e){alert("å¼‚å¸¸:"+e.message);hideLoading();}
  finally{isSubmitting=false;document.getElementById('submitButton').disabled=false;}
}

window.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('.product-button').forEach(b=>b.addEventListener('click',()=>selectProduct(b.dataset.name,b)));
  document.getElementById('submitButton').addEventListener('click',submitToAirtable);
  document.getElementById('backBtn').addEventListener('click',()=>window.location.href='main.html');
  document.getElementById('customProductInput').addEventListener('input',e=>{const v=e.target.value.trim();if(v){selectProduct(v,e.target);}});
});
</script>
<script src="auth.js"></script>
</body>
</html>
