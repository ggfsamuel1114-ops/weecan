
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weecan Invoice</title>
  <style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #e6f0fa;
    margin: 0;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  @media (min-width: 700px) {
    body { flex-direction: row; }
  }
  .input-area, .preview-area {
    flex: 1;
    padding: 20px;
    border-radius: 12px;
    margin: 10px;
    background: #f0f7ff;
    box-shadow: 0 0 10px rgba(100,150,200,0.15);
  }
  h3, h4 { color: #1a3d66; }
  .button-group {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
  }
  .button-group button, button {
    padding: 12px 18px;
    margin: 5px;
    font-size: 16px;
    background: #c9e4ff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .button-group button:hover, button:hover { background: #a9d3ff; }
  .product-button.active {
    background: #7cc6ff !important;
    border: 2px solid #2980b9;
    color: #fff;
  }
  input {
    padding: 12px;
    font-size: 16px;
    margin: 5px 0;
    border: 1px solid #aaccee;
    border-radius: 10px;
    background: #ffffff;
  }
  .invoice-box input[type="number"] {
    width: 80px;
    padding: 6px 8px;
    border: 1px solid #aaccee;
    border-radius: 8px;
    text-align: right;
    background: #f9fcff;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th { background: #d6ebff; color: #1a3d66; }
  th, td { border: 1px solid #c6def9; padding: 10px; text-align: center; }

  /* é®ç½© + Spinner */
  #loadingOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  #loadingOverlay div {
    background: white;
    padding: 20px 30px;
    border-radius: 10px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 20px; height: 20px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

  /* å¼¹å‡ºè¾“å…¥æ¡† */
  #popupInput {
    position: absolute;
    background: #fff;
    border: 1px solid #2980b9;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: none;
    z-index: 3000;
  }
  #popupInput h5 {
    margin: 6px 0;
    font-size: 14px;
    color: #1a3d66;
  }
  #popupInput input {
    width: 100px;
    margin-bottom: 6px;
    padding: 6px;
    font-size: 14px;
  }

  /* è‡ªå®šä¹‰è¾“å…¥æ¡†åƒæŒ‰é’® */
  .custom-input-btn {
    display: inline-block;
    padding: 12px 18px;
    margin: 5px;
    font-size: 16px;
    border: 2px dashed #7cc6ff;
    border-radius: 12px;
    background: #ffffff;
    color: #1a3d66;
    min-width: 140px;
    width: auto;
  }
  .custom-input-btn:focus {
    outline: none;
    border-color: #2980b9;
    background: #e6f3ff;
  }
  </style>
</head>
<body>
  <div class="input-area">
    <h3>ğŸ§¾ Name</h3>
    <input type="text" id="customerName" placeholder="å®¢æˆ·åå­— (å¿…å¡«)" />

    <h4>ğŸˆ Musang</h4>
    <div class="button-group">
      <button class="product-button" data-name="Musang AM">AM</button>
      <button class="product-button" data-name="Musang ABM">ABM</button>
      <button class="product-button" data-name="Musang BM">BM</button>
      <button class="product-button" data-name="Musang CM">CM</button>
      <button class="product-button" data-name="Musang CCM">CCM</button>
      <button class="product-button" data-name="Musang CCCM">CCCM</button>
    </div>

    <h4>ğŸŒ‘ Black Thorn</h4>
    <div class="button-group">
      <button class="product-button" data-name="BTA">BTA</button>
      <button class="product-button" data-name="BTB">BTB</button>
      <button class="product-button" data-name="BTC">BTC</button>
      <button class="product-button" data-name="BTCC">BTCC</button>
    </div>

    <h4>ğŸŒ• D24</h4>
    <div class="button-group">
      <button class="product-button" data-name="D24A">D24A</button>
      <button class="product-button" data-name="D24B">D24B</button>
      <button class="product-button" data-name="D24C">D24C</button>
    </div>

    <h4>ğŸƒ å…¶ä»–å“ç§</h4>
    <div class="button-group">
      <button class="product-button" data-name="Kampung">Kampung</button>
      <button class="product-button" data-name="KC">KC</button>
      <button class="product-button" data-name="Kahwin">KW</button>
      <input type="text" id="customProductInput" placeholder="è¾“å…¥è‡ªå®šä¹‰äº§å“åç§°" class="custom-input-btn" />
    </div>
    
    <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:15px;">
      <button type="button" id="backBtn">â¬…ï¸ Back</button>
    </div>
  </div>

  <div class="preview-area">
    <h3>ğŸ“‹ Invoice Overview</h3>
    <div class="invoice-box">
      <table>
        <thead>
          <tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="invoiceItems"></tbody>
      </table>
      <p><strong>æ€»è®¡ï¼š</strong>RM <span id="totalAmount">0.00</span></p>
    </div>
    <div style="margin-top:15px;text-align:right;">
      <button type="button" id="submitButton" style="display:none;">ğŸ“¤ æäº¤åˆ° Airtable</button>
    </div>
  </div>

  <!-- å¼¹å‡ºè¾“å…¥æ¡† -->
  <div id="popupInput">
    <div><b id="popupProductName"></b></div>
    <h5>é‡é‡ï¼ˆKGï¼‰</h5>
    <input type="number" id="popupWeight" placeholder="é‡é‡" />
    <h5>å•ä»·ï¼ˆRMï¼‰</h5>
    <input type="number" id="popupPrice" placeholder="å•ä»·" />
    <button type="button" onclick="confirmPopup()">ç¡®å®š</button>
  </div>

  <!-- Loading é®ç½© -->
  <div id="loadingOverlay">
    <div>
      <div class="spinner"></div>
      <span id="loadingText">æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...</span>
    </div>
  </div>

  <script>
  const API_URL = "https://weecan-airtable-api.vercel.app/api/salestoken";
  const items = [];
  let currentProduct = null;
  window.receiptNo = generateReceiptNo();

  function generateReceiptNo() {
    const now = new Date();
    const ymd = now.toISOString().slice(2,10).replace(/-/g,"");
    const rand = Math.floor(1000 + Math.random()*9000);
    return `SLS-${ymd}-${rand}`;
  }

  function selectProduct(name, btn) {
    currentProduct = name;
    document.getElementById('popupProductName').innerText = "ğŸ§º " + name;

    const rect = btn.getBoundingClientRect();
    const popup = document.getElementById('popupInput');
    popup.style.top = (window.scrollY + rect.bottom + 8) + "px";
    popup.style.left = (window.scrollX + rect.left) + "px";
    popup.style.display = "block";
  }

  function confirmPopup() {
    const w = parseFloat(document.getElementById('popupWeight').value);
    const p = parseFloat(document.getElementById('popupPrice').value);
    if(currentProduct && !isNaN(w) && !isNaN(p)) {
      items.push({product:currentProduct, weight:w, price:p});
      updateInvoice();
    } else {
      alert("è¯·å¡«å†™é‡é‡å’Œå•ä»·ï¼");
      return;
    }
    document.getElementById('popupWeight').value="";
    document.getElementById('popupPrice').value="";
    document.getElementById('popupInput').style.display="none";
  }

  function updateInvoice() {
    const tbody = document.getElementById('invoiceItems'); tbody.innerHTML='';
    let total=0;
    items.forEach((it,i)=>{
      const sub=it.weight*it.price; total+=sub;
      tbody.insertAdjacentHTML('beforeend',
        `<tr><td>${it.product}</td>
        <td><input type="number" value="${it.weight}" onchange="editItem(${i},'weight',this.value)"></td>
        <td><input type="number" value="${it.price.toFixed(2)}" onchange="editItem(${i},'price',this.value)"></td>
        <td>${sub.toFixed(2)}</td>
        <td><button type="button" onclick="deleteItem(${i})">âŒ åˆ é™¤</button></td></tr>`);
    });
    document.getElementById('totalAmount').innerText = total.toFixed(2);
    document.getElementById('submitButton').style.display = items.length ? 'inline-block':'none';
  }

  function deleteItem(i){ if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€é¡¹å—ï¼Ÿ')){ items.splice(i,1); updateInvoice(); }}
  function editItem(i,f,v){ const n=parseFloat(v); if(!isNaN(n)){ items[i][f]=n; updateInvoice(); }}

  function showLoading(msg="æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...") {
    document.getElementById("loadingText").innerText = msg;
    document.getElementById("loadingOverlay").style.display = "flex";
  }
  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  function printReceipt() {
    const cust = document.getElementById('customerName').value.trim() || 'N/A';
    const now = new Date();
    const timeStr = now.toLocaleString('zh-MY');
    const no = window.receiptNo || "N/A";
    let itemsHTML = '';
    let tot = 0;
    items.forEach(it => {
      const s = it.weight * it.price; tot += s;
      itemsHTML += `<tr><td>${it.product}</td><td>${it.weight.toFixed(2)}</td><td>RM ${it.price.toFixed(2)}</td><td>RM ${s.toFixed(2)}</td></tr>`;
    });

    const htmlContent = `
      <html><head><meta charset="UTF-8"/>
      <style>
        body { font-family: Arial, sans-serif; font-size: 12pt; }
        .header { text-align:center; font-size: 18pt; font-weight: bold; margin-bottom: 12px; }
        table { width:100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        tfoot td { font-weight: bold; background: #f5f5f5; }
      </style></head>
      <body>
        <div class="header">Sales Invoice</div>
        <p><b>å®¢æˆ·ï¼š</b>${cust}</p>
        <p><b>ç¼–å·ï¼š</b>${no}</p>
        <p><b>æ—¶é—´ï¼š</b>${timeStr}</p>
        <table>
          <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th></tr></thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot><tr><td colspan="3">æ€»è®¡</td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
        </table>
        <div style="text-align:center;margin-top:10px">â€ Thank You â€</div>
      </body></html>`;

    const iframe = document.createElement("iframe");
    iframe.style.position = "absolute"; iframe.style.left = "-9999px";
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(htmlContent); doc.close();
    iframe.contentWindow.focus(); iframe.contentWindow.print();
    setTimeout(() => document.body.removeChild(iframe), 1000);
  }

  let isSubmitting = false;
  async function submitToAirtable() {
    if (isSubmitting) return;
    isSubmitting = true;
    document.getElementById('submitButton').disabled = true;

    const cust = document.getElementById('customerName').value.trim();
    if (!cust || !items.length) {
      alert('è¯·å¡«å†™å®¢æˆ·åå­—å¹¶è‡³å°‘æ·»åŠ ä¸€ä¸ªå•†å“ï¼');
      isSubmitting = false;
      document.getElementById('submitButton').disabled = false;
      return;
    }

    showLoading("æ­£åœ¨æäº¤ï¼Œè¯·ç¨å€™...");

    try {
      for (const [i, it] of items.entries()) {
        const total = it.weight * it.price;
        const payload = {
          fields: {
            "Receipt Number": window.receiptNo,
            "Customer Name": cust,
            "Product Name": it.product,
            "Unit Price": it.price,
            "Weight": it.weight,
            "Total Price": total
          }
        };
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const errMsg = await res.text();
          hideLoading();
          alert(`âŒ ç¬¬ ${i+1} é¡¹æäº¤å¤±è´¥ï¼š${errMsg}`);
          isSubmitting = false;
          document.getElementById('submitButton').disabled = false;
          return;
        }
      }
      document.getElementById("loadingText").innerText = "âœ… æäº¤æˆåŠŸï¼Œæ­£åœ¨æ‰“å°...";
      printReceipt();
      setTimeout(() => window.location.href = 'main.html', 3000);
    } catch (error) {
      hideLoading();
      alert(`ğŸš¨ æäº¤å¼‚å¸¸: ${error.message}`);
    } finally {
      isSubmitting = false;
      document.getElementById('submitButton').disabled = false;
    }
  }

  // äº‹ä»¶ç»‘å®š
  window.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.product-button').forEach(b=>{
      b.addEventListener('click',(e)=>{
        e.stopPropagation();
        selectProduct(b.dataset.name, b);
      });
    });

    document.getElementById('customProductInput').addEventListener('input',e=>{
      const v = e.target.value.trim();
      if(v){
        currentProduct = v;
        document.getElementById('popupProductName').innerText = "ğŸ§º " + v;
        const rect = e.target.getBoundingClientRect();
        const popup = document.getElementById('popupInput');
        // æ”¹æˆå³è¾¹æ˜¾ç¤º
        popup.style.top = (window.scrollY + rect.top) + "px";
        popup.style.left = (window.scrollX + rect.right + 8) + "px";
        popup.style.display = "block";
      } else {
        document.getElementById('popupInput').style.display="none";
      }
    });

    document.getElementById('submitButton').addEventListener('click',submitToAirtable);
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = 'main.html';
    });
    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—
    document.addEventListener('click',(e)=>{
      const popup = document.getElementById('popupInput');
      if(popup.style.display==="block" && !popup.contains(e.target) && !e.target.classList.contains('product-button') && e.target.id!=="customProductInput"){
        popup.style.display="none";
        document.getElementById('popupWeight').value="";
        document.getElementById('popupPrice').value="";
      }
    });
  });
  </script>
</body>
</html>
