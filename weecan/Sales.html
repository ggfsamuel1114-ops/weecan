<!DOCTYPE html>
<html lang="zh-MY">
<head>
  <meta charset="UTF-8" />
  <title>Weecan Invoice</title>
  <style>
    :root {
      --primary:#3498db;
      --primary-dark:#2c80b4;
      --success:#27ae60;
      --info:#2980b9;
      --bg:#f4f6f9;
      --card-bg:#fff;
      --text-main:#2c3e50;
      --radius:14px;
    }
    body {
      font-family:"Segoe UI","Inter",sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text-main);
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    header {
      background:var(--card-bg);
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      padding:12px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1 {font-size:20px;margin:0;display:flex;align-items:center;gap:8px;}
    header button {
      background:var(--primary);
      color:#fff;
      border:none;
      padding:8px 16px;
      border-radius:var(--radius);
      cursor:pointer;
    }
    header button:hover{background:var(--primary-dark);}
    main {flex:1;display:flex;flex-direction:column;padding:20px;gap:20px;}
    @media(min-width:900px){main{flex-direction:row;}}
    .section {
      flex:1;
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:0 3px 12px rgba(0,0,0,.06);
    }
    #customerName {
      width: 60%;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccd;
      border-radius: var(--radius);
      margin-bottom: 15px;
    }
    .button-group {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
    .product-button {
      padding:10px 16px;
      font-size:14px;
      border:none;
      border-radius:var(--radius);
      cursor:pointer;
      background:linear-gradient(135deg,var(--info),#1f6693);
      color:#fff;
    }
    .product-button:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.12);}
    .btn {
      background:linear-gradient(135deg,var(--success),#219150);
      color:#fff;
      border:none;
      padding:10px 16px;
      border-radius:var(--radius);
      cursor:pointer;
      font-size:14px;
    }
    .btn.long{display:block;width:100%;margin-top:10px;}
    #customProductInput {
      margin-top: 10px;
      padding: 12px 18px;
      font-size: 15px;
      border: 2px dashed var(--primary);
      border-radius: var(--radius);
      background:#fff;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    table {width:100%;border-collapse:collapse;margin-top:15px;}
    th,td {border:1px solid #ddd;padding:8px;text-align:center;}
    th{background:#f5f5f5;}
    #popupInput {
      position:absolute;
      background:#fff;
      border:1px solid #ddd;
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 4px 10px rgba(0,0,0,.15);
      display:none;
      z-index:500;
      width:220px;
      text-align:center;
    }
    #popupInput b{display:block;margin-bottom:10px;}
    #popupInput input {
      display:block;
      width:100%;
      margin:6px 0;
      padding:8px;
      border:1px solid #ccc;
      border-radius:var(--radius);
      box-sizing:border-box;
    }
    @media print {
      header, #submitButton, .no-print, #toast, #loadingOverlay {display:none!important;}
      body,html,main,.section {
        display:block!important;
        height:auto!important;
        margin:0!important;
        padding:0!important;
        background:#fff!important;
        box-shadow:none!important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§¾ Sales</h1>
    <div class="header-actions">
      <button id="backBtn">â¬…ï¸ Back</button>
      <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <main id="mainContent">
    <!-- å·¦è¾¹è¾“å…¥åŒº -->
    <div class="section">
      <h3>å®¢æˆ·ä¿¡æ¯</h3>
      <input type="text" id="customerName" placeholder="å®¢æˆ·åå­— (å¿…å¡«)" />

      <h4>ğŸˆ Musang</h4>
      <div class="button-group">
        <button class="product-button" data-name="Musang AM">AM</button>
        <button class="product-button" data-name="Musang ABM">ABM</button>
        <button class="product-button" data-name="Musang BM">BM</button>
        <button class="product-button" data-name="Musang CM">CM</button>
        <button class="product-button" data-name="Musang CCM">CCM</button>
        <button class="product-button" data-name="Musang CCCM">CCCM</button>
      </div>
      <h4>ğŸŒ‘ Black Thorn</h4>
      <div class="button-group">
        <button class="product-button" data-name="BTA">BTA</button>
        <button class="product-button" data-name="BTB">BTB</button>
        <button class="product-button" data-name="BTC">BTC</button>
        <button class="product-button" data-name="BTCC">BTCC</button>
      </div>
      <h4>ğŸŒ• D24</h4>
      <div class="button-group">
        <button class="product-button" data-name="D24A">D24A</button>
        <button class="product-button" data-name="D24B">D24B</button>
        <button class="product-button" data-name="D24C">D24C</button>
      </div>
      <h4>ğŸƒ å…¶ä»–å“ç§</h4>
      <div class="button-group">
        <button class="product-button" data-name="Kampung">Kampung</button>
        <button class="product-button" data-name="KC">KC</button>
        <button class="product-button" data-name="Kahwin">KW</button>
      </div>
      <input type="text" id="customProductInput" placeholder="è¾“å…¥è‡ªå®šä¹‰äº§å“åç§° (æŒ‰å›è½¦ç¡®è®¤)" />
    </div>

    <!-- å³è¾¹é¢„è§ˆåŒº -->
    <div class="section">
      <h3>ğŸ“‹ Invoice Overview</h3>
      <table>
        <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="invoiceItems"></tbody>
      </table>
      <p><strong>æ€»è®¡ï¼š</strong>RM <span id="totalAmount">0.00</span></p>
      <div style="text-align:right;">
        <button id="submitButton" class="btn" style="display:none;">ğŸ“¤ æäº¤åˆ° Airtable</button>
      </div>
    </div>
  </main>

  <!-- popup è¾“å…¥ -->
  <div id="popupInput">
    <b id="popupProductName"></b>
    <input type="number" id="popupWeight" placeholder="é‡é‡ (KG)" />
    <input type="number" id="popupPrice" placeholder="å•ä»· (RM)" />
    <button onclick="confirmPopup()" class="btn long">ç¡®å®š</button>
  </div>

  <!-- Toast -->
  <div id="toast" style="visibility:hidden;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
        background:#333;color:#fff;padding:10px 20px;border-radius:8px;z-index:999;">æç¤º</div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;
        background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;flex-direction:column;">
     <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.3);">
       <span id="loadingText">Loading...</span>
     </div>
  </div>

  <script>
    const API_URL="https://syve-dinvoice-system.vercel.app/api/salestoken";
    const items=[]; let currentProduct=null; let isCustom=false;
    window.receiptNo=generateReceiptNo();

    function generateReceiptNo(){
      const now=new Date();
      const ymd=now.toISOString().slice(2,10).replace(/-/g,"");
      const rand=Math.floor(1000+Math.random()*9000);
      return `SLS-${ymd}-${rand}`;
    }

    function selectProduct(name,btn){
      currentProduct=name; isCustom=false;
      document.getElementById('popupProductName').innerText="ğŸ§º "+name;
      const rect=btn.getBoundingClientRect();
      const popup=document.getElementById('popupInput');
      popup.style.top=(window.scrollY+rect.bottom+8)+"px";
      popup.style.left=(window.scrollX+rect.left)+"px";
      popup.style.display="block";
      document.getElementById('customProductInput').value="";
    }

    function confirmPopup(){
      const w=parseFloat(document.getElementById('popupWeight').value);
      const p=parseFloat(document.getElementById('popupPrice').value);
      if(currentProduct&&!isNaN(w)&&!isNaN(p)){
        items.push({product:currentProduct,weight:w,price:p});
        updateInvoice(); showToast("âœ… æ·»åŠ æˆåŠŸ");
      } else {alert("è¯·å¡«å†™é‡é‡å’Œå•ä»·ï¼"); return;}
      document.getElementById('popupWeight').value="";
      document.getElementById('popupPrice').value="";
      document.getElementById('popupInput').style.display="none";
      if(isCustom){document.getElementById('customProductInput').value="";}
    }

    function updateInvoice(){
      const tbody=document.getElementById('invoiceItems');tbody.innerHTML=''; let total=0;
      items.forEach((it,i)=>{const sub=it.weight*it.price; total+=sub;
        tbody.insertAdjacentHTML('beforeend',
          `<tr><td>${it.product}</td>
          <td><input type="number" value="${it.weight}" onchange="editItem(${i},'weight',this.value)"></td>
          <td><input type="number" value="${it.price.toFixed(2)}" onchange="editItem(${i},'price',this.value)"></td>
          <td>${sub.toFixed(2)}</td>
          <td><button onclick="deleteItem(${i})">âŒ åˆ é™¤</button></td></tr>`);});
      document.getElementById('totalAmount').innerText=total.toFixed(2);
      document.getElementById('submitButton').style.display=items.length?'inline-block':'none';
    }

    function editItem(i,f,v){const n=parseFloat(v);if(!isNaN(n)){items[i][f]=n;updateInvoice();}}
    function deleteItem(i){if(confirm('ç¡®å®šåˆ é™¤?')){items.splice(i,1);updateInvoice();}}
    function logout(){alert("å·²é€€å‡ºç™»å½•");}
    function showToast(msg){const t=document.getElementById("toast");t.innerText=msg;t.style.visibility="visible";setTimeout(()=>t.style.visibility="hidden",2000);}
    function showLoading(msg="..."){document.getElementById("loadingText").innerText=msg;document.getElementById("loadingOverlay").style.display="flex";}
    function hideLoading(){document.getElementById("loadingOverlay").style.display="none";}

    // âœ… æ”¶æ®é¢„è§ˆ + æ‰“å°
    function showReceiptPage(cust, items){
      const now=new Date(); const timeStr=now.toLocaleString('zh-MY'); const no=window.receiptNo;
      let itemsHTML='',tot=0;
      items.forEach(it=>{const s=it.weight*it.price;tot+=s;
        itemsHTML+=`<tr><td>${it.product}</td><td>${it.weight.toFixed(2)}</td><td>RM ${it.price.toFixed(2)}</td><td>RM ${s.toFixed(2)}</td></tr>`;});
      document.getElementById("mainContent").innerHTML=`
        <div class="section receipt-container" style="max-width:600px;margin:0 auto;">
          <h2 style="text-align:center;">Sales Receipt</h2>
          <p><b>å®¢æˆ·ï¼š</b>${cust}</p>
          <p><b>ç¼–å·ï¼š</b>${no}</p>
          <p><b>æ—¶é—´ï¼š</b>${timeStr}</p>
          <table>
            <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>æ€»ä»·</th></tr></thead>
            <tbody>${itemsHTML}</tbody>
            <tfoot><tr><td colspan="3"><b>æ€»è®¡</b></td><td><b>RM ${tot.toFixed(2)}</b></td></tr></tfoot>
          </table>
          <div style="text-align:center;margin-top:20px;">â€ Thank You â€</div>
          <div class="no-print" style="display:flex;gap:12px;margin-top:20px;justify-content:center;">
            <button class="btn" onclick="setPaper('a4')">ğŸ–¨ æ‰“å° A4</button>
            <button class="btn" onclick="setPaper('receipt')">ğŸ§¾ æ‰“å°å°ç¥¨</button>
            <button class="btn" onclick="window.location.reload()">â¬… è¿”å›</button>
          </div>
        </div>`;
    }

    // âœ… æ‰“å°æ ·å¼
    function setPaper(type){
      if(type==='a4'){
        const style=`@page { size: A4 portrait; margin: 15mm; }
          body, html {
            margin:0;
            padding:0;
            height:auto !important;
            background:#fff !important;
          }
          main { display:block !important; padding:0 !important; }
          .receipt-container {
            width:100% !important;
            max-width:100% !important;
            margin:0 auto !important;
            box-shadow:none !important;
            border:none !important;
            padding:0 !important;
          }
          table {width:100%;border-collapse:collapse;margin-top:10px;}
          th,td {border:1px solid #000;padding:6px;text-align:center;}
          tfoot td {font-weight:bold;border-top:2px solid #000;}`; 
        applyPrintStyle(style);
      } else {
        const style=`@page { size: 58mm auto; margin:0; }
          body { margin:0; }
          .receipt-container {
            width:58mm!important;
            max-width:58mm!important;
            font-family:monospace;
            font-size:10pt;
            box-shadow:none!important;
            border:none!important;
            padding:4px!important;
          }
          table {width:100%;font-size:9pt;border-collapse:collapse;}
          th,td {padding:2px 0;text-align:left;}
          tfoot td {border-top:1px dashed #000;font-weight:bold;}`; 
        applyPrintStyle(style);
      }
      window.print();
    }

    function applyPrintStyle(css){
      let s=document.getElementById('printStyle');
      if(!s){s=document.createElement('style');s.id='printStyle';document.head.appendChild(s);}
      s.innerHTML=css+`@media print{.no-print{display:none!important;}}`;
    }

    let isSubmitting=false;
    async function submitToAirtable(){
      if(isSubmitting)return;isSubmitting=true;
      document.getElementById('submitButton').disabled=true;
      const cust=document.getElementById('customerName').value.trim();
      if(!cust||!items.length){alert('è¯·å¡«å†™å®¢æˆ·åå­—å¹¶è‡³å°‘æ·»åŠ ä¸€é¡¹');isSubmitting=false;document.getElementById('submitButton').disabled=false;return;}
      showLoading("æ­£åœ¨æäº¤...");
      try{
        for(const it of items){
          const payload={fields:{"Receipt Number":window.receiptNo,"Customer Name":cust,"Product Name":it.product,"Unit Price":it.price,"Weight":it.weight,"Total Price":it.weight*it.price}};
          const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(!res.ok){alert("âŒ æäº¤å¤±è´¥");hideLoading();return;}
        }
        hideLoading(); showReceiptPage(cust,items);
      }catch(e){alert("å¼‚å¸¸:"+e.message);hideLoading();}
      finally{isSubmitting=false;document.getElementById('submitButton').disabled=false;}
    }

    // è‡ªå®šä¹‰è¾“å…¥æ¡†ç›‘å¬
    const custom=document.getElementById('customProductInput');
    custom.addEventListener('input',()=>{
      const v=custom.value.trim(); const popup=document.getElementById('popupInput');
      if(v){currentProduct=v;isCustom=true;
        document.getElementById('popupProductName').innerText="ğŸ§º "+v;
        const rect=custom.getBoundingClientRect();
        popup.style.top=(window.scrollY+rect.bottom+8)+"px";
        popup.style.left=(window.scrollX+rect.left)+"px";
        popup.style.display="block";
      }else{popup.style.display="none";}
    });

    document.addEventListener('click',(e)=>{
      const popup=document.getElementById('popupInput');
      if(popup.style.display==="block"&&!popup.contains(e.target)&&!e.target.classList.contains('product-button')&&e.target.id!=="customProductInput"){
        popup.style.display="none";
        document.getElementById('popupWeight').value="";
        document.getElementById('popupPrice').value="";
      }
    });

    window.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.product-button').forEach(b=>b.addEventListener('click',()=>selectProduct(b.dataset.name,b)));
      document.getElementById('submitButton').addEventListener('click',submitToAirtable);
      document.getElementById('backBtn').addEventListener('click',()=>window.location.href='main.html');
    });
  </script>
  <script src="auth.js"></script>
</body>
</html>
