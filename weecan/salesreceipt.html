<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>History Center - Sales Invoice</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: center; }
    button { padding: 6px 12px; border: none; background: #d9ecf2; cursor: pointer; border-radius: 8px; }
    button:hover { background: #b9d9e7; }
    #searchBar { padding: 8px; font-size: 16px; width: 100%; max-width: 400px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; }
    .pagination { margin-top: 15px; }
    .pagination button { margin: 0 5px; }

    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .modal-close { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; float: right; }

    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 2000; }
    #loadingOverlay div { background: white; padding: 20px 30px; border-radius: 10px; font-size: 16px; display: flex; align-items: center; gap: 10px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  <!-- å¼•å…¥ jsPDF & autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <h2>Sales History</h2>
  <button onclick="sendBack()">ğŸ”™ è¿”å›é¦–é¡µ</button>
  <input type="text" id="searchBar" placeholder="ğŸ” æœç´¢æ”¶æ®ç¼–å·ã€å®¢æˆ·åã€é‡‘é¢æˆ–æ—¥æœŸ..." oninput="filterTable()" />

  <table id="historyTable">
    <thead>
      <tr>
        <th>æ”¶æ®ç¼–å·</th>
        <th>å®¢æˆ·</th>
        <th>æ—¶é—´</th>
        <th>é‡‘é¢ (RM)</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">â¬… ä¸Šä¸€é¡µ</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">ä¸‹ä¸€é¡µ â¡</button>
  </div>

  <!-- æ¨¡æ€å¼¹çª— -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">å…³é—­ âœ–</button>
      <h3>æ”¶æ®è¯¦æƒ…</h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Loading é®ç½© -->
  <div id="loadingOverlay">
    <div>
      <div class="spinner"></div>
      <span>æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</span>
    </div>
  </div>

  <script>
    const API_URL = "https://syve-dinvoice-system.vercel.app/api/salesreceipt";
    let allRecords = [], uniqueRows = [];
    let currentPage = 1, rowsPerPage = 20, filteredRows = [];

    function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
    function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

    async function fetchAllReceipts() {
      showLoading();
      try {
        const res = await fetch(API_URL);
        let records = await res.json();
        records.forEach(r => { if (!r.fields["Status"]) r.fields["Status"] = "Active"; });
        return records;
      } finally { hideLoading(); }
    }

    function sendBack() { window.location.href = 'main.html'; }

    function renderTable(page = 1) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredRows.slice(start, end);

      pageData.forEach(rec => {
        const f = rec.fields;
        const no = f["Receipt Number"] || "â€”";
        const name = f["Customer Name"] || "â€”";
        const time = f["Time Stamp"] ? new Date(f["Time Stamp"]).toLocaleString("zh-MY") : "â€”";

        const sameReceiptRows = allRecords.filter(r => r.fields["Receipt Number"] === no);
        let totalAmount = 0;
        sameReceiptRows.forEach(r => {
          const w = parseFloat(r.fields["Weight"]) || 0;
          const p = parseFloat(r.fields["Unit Price"]) || 0;
          totalAmount += w * p;
        });

        const status = f["Status"] || "Active";
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${no}</td>
            <td>${name}</td>
            <td>${time}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
              ${status === "Cancelled"
                ? "<span style='color:red;font-weight:bold'>å·²å–æ¶ˆ</span>"
                : `
                  <button onclick="viewOne('${no}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                  <button onclick="printOne('${no}')">ğŸ–¨ï¸ æ‰“å°</button>
                  <button onclick="cancelReceipt('${rec.id}', '${no}')">âŒ å–æ¶ˆ</button>
                `}
            </td>
          </tr>
        `);
      });

      document.getElementById("pageInfo").textContent =
        `ç¬¬ ${currentPage} é¡µ / å…± ${Math.ceil(filteredRows.length / rowsPerPage)} é¡µï¼ˆå…± ${filteredRows.length} æ¡è®°å½•ï¼‰`;
    }

    function viewOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("æ‰¾ä¸åˆ°è¯¥æ”¶æ®");

      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");

      let itemsHTML = "";
      let tot = 0;
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
        itemsHTML += `<tr><td>${product}</td><td>${weight.toFixed(2)} kg</td><td>RM ${price.toFixed(2)}</td><td>RM ${subtotal.toFixed(2)}</td></tr>`;
      });

      document.getElementById("modalBody").innerHTML = `
        <p><strong>å®¢æˆ·ï¼š</strong>${cust}</p>
        <p><strong>ç¼–å·ï¼š</strong>${receiptNo}</p>
        <p><strong>æ—¶é—´ï¼š</strong>${timeStr}</p>
        <table>
          <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>å°è®¡</th></tr></thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot><tr><td colspan="3"><strong>æ€»è®¡</strong></td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
        </table>
      `;
      document.getElementById("receiptModal").style.display = "flex";
    }

    function closeModal() { document.getElementById("receiptModal").style.display = "none"; }

    async function cancelReceipt(recordId, receiptNo) {
      if (!confirm(`ç¡®å®šè¦å–æ¶ˆæ”¶æ® ${receiptNo} å—ï¼Ÿ`)) return;
      showLoading();
      try {
        const payload = { recordId, status: "Cancelled" };
        const res = await fetch("https://syve-dinvoice-system.vercel.app/api/updateSaleStatus", {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          alert("âœ… æ”¶æ®å·²å–æ¶ˆï¼");
          const rec = allRecords.find(r => r.id === recordId);
          if (rec) rec.fields["Status"] = "Cancelled";
          renderTable(currentPage);
        } else {
          alert("âŒ å–æ¶ˆå¤±è´¥: " + (result.error?.message || "æœªçŸ¥é”™è¯¯"));
        }
      } catch { alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•å–æ¶ˆæ”¶æ®"); }
      finally { hideLoading(); }
    }

    function filterTable() {
      const kw = document.getElementById("searchBar").value.toLowerCase();
      filteredRows = uniqueRows.filter(r => {
        const f = r.fields;
        const no = (f["Receipt Number"] || "").toLowerCase();
        const name = (f["Customer Name"] || "").toLowerCase();
        let totalAmount = 0;
        allRecords.filter(row => row.fields["Receipt Number"] === f["Receipt Number"])
          .forEach(row => {
            const w = parseFloat(row.fields["Weight"]) || 0;
            const p = parseFloat(row.fields["Unit Price"]) || 0;
            totalAmount += w * p;
          });
        const amountStr = totalAmount.toFixed(2);
        const dateObj = f["Time Stamp"] ? new Date(f["Time Stamp"]) : null;
        const timeStr = dateObj ? dateObj.toLocaleString("zh-MY") : "";
        const isoStr = dateObj ? dateObj.toISOString().split("T")[0] : "";
        return no.includes(kw) || name.includes(kw) || amountStr.includes(kw)
          || timeStr.toLowerCase().includes(kw) || isoStr.includes(kw);
      });
      currentPage = 1;
      renderTable();
    }

    function prevPage() { if (currentPage > 1) { currentPage--; renderTable(currentPage); } }
    function nextPage() { if (currentPage < Math.ceil(filteredRows.length / rowsPerPage)) { currentPage++; renderTable(currentPage); } }

    // ğŸŸ¡ æ”¹è‰¯ç‰ˆæ‰“å°å‡½æ•°ï¼ˆé¢„è§ˆ + è¿”å›æŒ‰é’®ï¼‰
    function printOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("Invoice not found");
    
      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("en-GB");
    
      let tot = 0;
      let itemsHTML = "";
    
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
    
        itemsHTML += `
          <tr>
            <td>${product}</td>
            <td>${weight.toFixed(2)} kg</td>
            <td>RM ${price.toFixed(2)}</td>
            <td>RM ${subtotal.toFixed(2)}</td>
          </tr>`;
      });
    
      // æ–°å¼€ä¸€ä¸ªé¢„è§ˆçª—å£ï¼ˆæ‰‹æœº + ç”µè„‘ç»Ÿä¸€é€»è¾‘ï¼‰
      const win = window.open("", "_blank");
      win.document.write(`
        <html>
          <head>
            <meta charset="UTF-8"/>
            <title>Invoice ${receiptNo}</title>
            <style>
              body { font-family: Arial, sans-serif; font-size: 12pt; padding:20px; }
              .header { text-align:center; font-size: 18pt; font-weight: bold; margin-bottom: 10px; }
              table { width:100%; border-collapse: collapse; margin-top: 10px; }
              th, td { border: 1px solid #000; padding: 6px; text-align: center; }
              th { background: #f5f5f5; }
              tfoot td { font-weight: bold; background: #f5f5f5; }
              .btn { margin: 10px; padding: 8px 16px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
              .btn:hover { background:#2c80b4; }
            </style>
          </head>
          <body>
            <div class="header">Sales Invoice</div>
            <p><b>Customer:</b> ${cust}</p>
            <p><b>Invoice:</b> ${receiptNo}</p>
            <p><b>Date:</b> ${timeStr}</p>
            <table>
              <thead>
                <tr><th>Item</th><th>Weight (kg)</th><th>Price (RM)</th><th>Subtotal (RM)</th></tr>
              </thead>
              <tbody>${itemsHTML}</tbody>
              <tfoot>
                <tr><td colspan="3">Total</td><td>RM ${tot.toFixed(2)}</td></tr>
              </tfoot>
            </table>
            <div style="text-align:center;margin-top:15px">â€ Thank You â€</div>
    
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div style="text-align:center; margin-top:30px;">
              <button class="btn" onclick="window.print()">ğŸ–¨ æ‰“å° / å­˜ PDF</button>
              <button class="btn" onclick="window.close()">â¬… è¿”å›</button>
            </div>
          </body>
        </html>
      `);
      win.document.close();
    }


    // åˆå§‹åŒ–æ•°æ®
    fetchAllReceipts().then(records => {
      allRecords = records;
      const seen = new Set();
      records.forEach(r => {
        const n = r.fields["Receipt Number"];
        if (!seen.has(n)) { uniqueRows.push(r); seen.add(n); }
      });
      filteredRows = uniqueRows;
      renderTable();
    });
  </script>
</body>
</html>
