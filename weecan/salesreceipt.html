<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>History Center - Sales Invoice</title>
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2c80b4;
      --success: #27ae60;
      --warning: #e67e22;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --text-main: #2c3e50;
      --radius: 12px;
    }

    body {
      font-family: "Segoe UI", "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      color: var(--text-main);
      padding: 0;
    }

    header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    header button {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none;
      padding: 8px 16px;
      color: white;
      font-size: 14px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.3s;
    }
    header button:hover {
      background: var(--primary-dark);
    }

    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }

    #searchBar {
      padding: 10px 14px;
      font-size: 15px;
      width: 100%;
      max-width: 400px;
      margin: 15px 0;
      border-radius: var(--radius);
      border: 1px solid #ccd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
    }
    th, td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: center;
    }
    th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .pagination {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .pagination button {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .pagination button:hover {
      background: var(--primary-dark);
    }

    /* æ“ä½œæŒ‰é’® */
    table button {
      padding: 6px 12px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      margin: 2px;
    }
    table button:hover { opacity: 0.9; }
    .btn-view { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-print { background: linear-gradient(135deg, var(--success), #219150); color: white; }
    .btn-cancel { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      animation: fadeIn 0.3s ease;
    }
    .modal-close {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      float: right;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Loading é®ç½© */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(3px);
    }
    #loadingOverlay div {
      background: var(--card-bg);
      padding: 20px 30px;
      border-radius: var(--radius);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“œ Sales History</h2>
    <button onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
  </header>

  <main>
    <input type="text" id="searchBar" placeholder="ğŸ” æœç´¢æ”¶æ®ç¼–å·ã€å®¢æˆ·åã€é‡‘é¢æˆ–æ—¥æœŸ..." oninput="filterTable()" />

    <table id="historyTable">
      <thead>
        <tr>
          <th>æ”¶æ®ç¼–å·</th>
          <th>å®¢æˆ·</th>
          <th>æ—¶é—´</th>
          <th>é‡‘é¢ (RM)</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination">
      <button onclick="prevPage()">â¬… ä¸Šä¸€é¡µ</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">ä¸‹ä¸€é¡µ â¡</button>
    </div>
  </main>

  <!-- æ¨¡æ€å¼¹çª— -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">å…³é—­ âœ–</button>
      <h3>æ”¶æ®è¯¦æƒ…</h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Loading é®ç½© -->
  <div id="loadingOverlay">
    <div>
      <div class="spinner"></div>
      <span>æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</span>
    </div>
  </div>

  <!-- auth.js ç™»å½•æ ¡éªŒ -->
  <script src="auth.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const token = localStorage.getItem("token");
      if (!token) {
        document.body.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;">
            <h2 style="color:#e74c3c;">âŒ Access Denied</h2>
            <p>You must login before using the system.</p>
            <a href="login.html" style="margin-top:20px;padding:10px 20px;background:#3498db;color:white;border-radius:6px;text-decoration:none;">
              ğŸ”‘ Go to Login
            </a>
          </div>
        `;
      }
    });
  </script>
  
  <script>
    const API_URL = "https://syve-dinvoice-system.vercel.app/api/salesreceipt";
    let allRecords = [], uniqueRows = [];
    let currentPage = 1, rowsPerPage = 20, filteredRows = [];

    function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
    function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

    async function fetchAllReceipts() {
      showLoading();
      try {
        const res = await fetch(API_URL);
        let records = await res.json();
        records.forEach(r => { if (!r.fields["Status"]) r.fields["Status"] = "Active"; });
        return records;
      } finally { hideLoading(); }
    }

    function sendBack() { window.location.href = 'main.html'; }

    function renderTable(page = 1) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredRows.slice(start, end);

      pageData.forEach(rec => {
        const f = rec.fields;
        const no = f["Receipt Number"] || "â€”";
        const name = f["Customer Name"] || "â€”";
        const time = f["Time Stamp"] ? new Date(f["Time Stamp"]).toLocaleString("zh-MY") : "â€”";

        const sameReceiptRows = allRecords.filter(r => r.fields["Receipt Number"] === no);
        let totalAmount = 0;
        sameReceiptRows.forEach(r => {
          const w = parseFloat(r.fields["Weight"]) || 0;
          const p = parseFloat(r.fields["Unit Price"]) || 0;
          totalAmount += w * p;
        });

        const status = f["Status"] || "Active";
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${no}</td>
            <td>${name}</td>
            <td>${time}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
              ${status === "Cancelled"
                ? "<span style='color:red;font-weight:bold'>å·²å–æ¶ˆ</span>"
                : `
                  <button onclick="viewOne('${no}')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                  <button onclick="printOne('${no}')">ğŸ–¨ï¸ æ‰“å°</button>
                  <button onclick="cancelReceipt('${rec.id}', '${no}')">âŒ å–æ¶ˆ</button>
                `}
            </td>
          </tr>
        `);
      });

      document.getElementById("pageInfo").textContent =
        `ç¬¬ ${currentPage} é¡µ / å…± ${Math.ceil(filteredRows.length / rowsPerPage)} é¡µï¼ˆå…± ${filteredRows.length} æ¡è®°å½•ï¼‰`;
    }

    function viewOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("æ‰¾ä¸åˆ°è¯¥æ”¶æ®");

      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");

      let itemsHTML = "";
      let tot = 0;
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
        itemsHTML += `<tr><td>${product}</td><td>${weight.toFixed(2)} kg</td><td>RM ${price.toFixed(2)}</td><td>RM ${subtotal.toFixed(2)}</td></tr>`;
      });

      document.getElementById("modalBody").innerHTML = `
        <p><strong>å®¢æˆ·ï¼š</strong>${cust}</p>
        <p><strong>ç¼–å·ï¼š</strong>${receiptNo}</p>
        <p><strong>æ—¶é—´ï¼š</strong>${timeStr}</p>
        <table>
          <thead><tr><th>äº§å“</th><th>é‡é‡</th><th>å•ä»·</th><th>å°è®¡</th></tr></thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot><tr><td colspan="3"><strong>æ€»è®¡</strong></td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
        </table>
      `;
      document.getElementById("receiptModal").style.display = "flex";
    }

    function closeModal() { document.getElementById("receiptModal").style.display = "none"; }

    async function cancelReceipt(recordId, receiptNo) {
      if (!confirm(`ç¡®å®šè¦å–æ¶ˆæ”¶æ® ${receiptNo} å—ï¼Ÿ`)) return;
      showLoading();
      try {
        const payload = { recordId, status: "Cancelled" };
        const res = await fetch("https://syve-dinvoice-system.vercel.app/api/updateSaleStatus", {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          alert("âœ… æ”¶æ®å·²å–æ¶ˆï¼");
          const rec = allRecords.find(r => r.id === recordId);
          if (rec) rec.fields["Status"] = "Cancelled";
          renderTable(currentPage);
        } else {
          alert("âŒ å–æ¶ˆå¤±è´¥: " + (result.error?.message || "æœªçŸ¥é”™è¯¯"));
        }
      } catch { alert("âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•å–æ¶ˆæ”¶æ®"); }
      finally { hideLoading(); }
    }

    function filterTable() {
      const kw = document.getElementById("searchBar").value.toLowerCase();
      filteredRows = uniqueRows.filter(r => {
        const f = r.fields;
        const no = (f["Receipt Number"] || "").toLowerCase();
        const name = (f["Customer Name"] || "").toLowerCase();
        let totalAmount = 0;
        allRecords.filter(row => row.fields["Receipt Number"] === f["Receipt Number"])
          .forEach(row => {
            const w = parseFloat(row.fields["Weight"]) || 0;
            const p = parseFloat(row.fields["Unit Price"]) || 0;
            totalAmount += w * p;
          });
        const amountStr = totalAmount.toFixed(2);
        const dateObj = f["Time Stamp"] ? new Date(f["Time Stamp"]) : null;
        const timeStr = dateObj ? dateObj.toLocaleString("zh-MY") : "";
        const isoStr = dateObj ? dateObj.toISOString().split("T")[0] : "";
        return no.includes(kw) || name.includes(kw) || amountStr.includes(kw)
          || timeStr.toLowerCase().includes(kw) || isoStr.includes(kw);
      });
      currentPage = 1;
      renderTable();
    }

    function prevPage() { if (currentPage > 1) { currentPage--; renderTable(currentPage); } }
    function nextPage() { if (currentPage < Math.ceil(filteredRows.length / rowsPerPage)) { currentPage++; renderTable(currentPage); } }

    // ğŸŸ¡ æ”¹è‰¯ç‰ˆæ‰“å°å‡½æ•°ï¼ˆé¢„è§ˆ + è¿”å›æŒ‰é’®ï¼‰
    function printOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("Invoice not found");
    
      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("en-GB");
    
      let tot = 0;
      let itemsHTML = "";
    
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
    
        itemsHTML += `
          <tr>
            <td>${product}</td>
            <td>${weight.toFixed(2)} kg</td>
            <td>RM ${price.toFixed(2)}</td>
            <td>RM ${subtotal.toFixed(2)}</td>
          </tr>`;
      });
    
      const win = window.open("", "_blank");
      win.document.write(`
        <html>
          <head>
            <meta charset="UTF-8"/>
            <title>Invoice ${receiptNo}</title>
            <style>
              body { font-family: Arial, sans-serif; font-size: 12pt; padding:20px; }
              .header { text-align:center; font-size: 18pt; font-weight: bold; margin-bottom: 10px; }
              table { width:100%; border-collapse: collapse; margin-top: 10px; }
              th, td { border: 1px solid #000; padding: 6px; text-align: center; }
              th { background: #f5f5f5; }
              tfoot td { font-weight: bold; background: #f5f5f5; }
              .btn { margin: 10px; padding: 8px 16px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
              .btn:hover { background:#2c80b4; }
              /* æ‰“å°æ—¶éšè—æŒ‰é’® */
              @media print {
                .no-print { display: none !important; }
              }
            </style>
          </head>
          <body>
            <div class="header">Sales Invoice</div>
            <p><b>Customer:</b> ${cust}</p>
            <p><b>Invoice:</b> ${receiptNo}</p>
            <p><b>Date:</b> ${timeStr}</p>
            <table>
              <thead>
                <tr><th>Item</th><th>Weight (kg)</th><th>Price (RM)</th><th>Subtotal (RM)</th></tr>
              </thead>
              <tbody>${itemsHTML}</tbody>
              <tfoot>
                <tr><td colspan="3">Total</td><td>RM ${tot.toFixed(2)}</td></tr>
              </tfoot>
            </table>
            <div style="text-align:center;margin-top:15px">â€ Thank You â€</div>
    
            <!-- æŒ‰é’®åŒºåŸŸï¼ˆæ‰“å°æ—¶éšè—ï¼‰ -->
            <div class="no-print" style="text-align:center; margin-top:30px;">
              <button class="btn" onclick="window.print()">ğŸ–¨ æ‰“å° / å­˜ PDF</button>
              <button class="btn" onclick="window.close()">â¬… è¿”å›</button>
            </div>
          </body>
        </html>
      `);
      win.document.close();
    }
    // åˆå§‹åŒ–æ•°æ®
    fetchAllReceipts().then(records => {
      allRecords = records;
      const seen = new Set();
      records.forEach(r => {
        const n = r.fields["Receipt Number"];
        if (!seen.has(n)) { uniqueRows.push(r); seen.add(n); }
      });
      filteredRows = uniqueRows;
      renderTable();
    });
  </script>
</body>
</html>
