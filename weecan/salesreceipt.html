<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>History Center - Sales Invoice</title>
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2c80b4;
      --success: #27ae60;
      --warning: #e67e22;
      --info: #2980b9;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --text-main: #2c3e50;
      --text-muted: #7f8c8d;
      --radius: 14px;
    }
    body {
      font-family: "Segoe UI", "Inter", sans-serif;
      background: var(--bg);
      margin: 0;
      color: var(--text-main);
      padding: 0;
    }
    header {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h2 { margin: 0; font-size: 20px; font-weight: 600; }
    header button {
      background: var(--primary);
      border: none;
      padding: 8px 16px;
      color: white;
      font-size: 14px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.3s;
    }
    header button:hover { background: var(--primary-dark); }
    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }
    #searchBar {
      padding: 10px 14px;
      font-size: 15px;
      width: 100%;
      max-width: 400px;
      margin: 15px 0;
      border-radius: var(--radius);
      border: 1px solid #ccd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
    }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #f5f5f5; font-weight: 600; }
    .pagination {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .pagination button {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: var(--radius);
      cursor: pointer;
    }
    .pagination button:hover { background: var(--primary-dark); }
    table button {
      padding: 6px 12px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      margin: 2px;
    }
    table button:hover { opacity: 0.9; }
    .btn-view { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-print { background: linear-gradient(135deg, var(--success), #219150); color: white; }
    .btn-cancel { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .btn-back { background: linear-gradient(135deg, var(--warning), #cf6717); color: white; }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      animation: fadeIn 0.3s ease;
    }
    .modal-close {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      float: right;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(3px);
    }
    #loadingOverlay div {
      background: var(--card-bg);
      padding: 20px 30px;
      border-radius: var(--radius);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <h2>üìú Sales History</h2>
    <div class="header-actions">
      <button onclick="sendBack()">‚¨Ö Back</button>
      <button onclick="logout()">üö™ ÈÄÄÂá∫ÁôªÂΩï</button>
    </div>
  </header>

  <main>
    <input type="text" id="searchBar" placeholder="üîç ÊêúÁ¥¢Êî∂ÊçÆÁºñÂè∑„ÄÅÂÆ¢Êà∑Âêç„ÄÅÈáëÈ¢ùÊàñÊó•Êúü..." oninput="filterTable()" />
    <table id="historyTable">
      <thead>
        <tr>
          <th>Êî∂ÊçÆÁºñÂè∑</th>
          <th>ÂÆ¢Êà∑</th>
          <th>Êó∂Èó¥</th>
          <th>ÈáëÈ¢ù (RM)</th>
          <th>Êìç‰Ωú</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination">
      <button onclick="prevPage()">‚¨Ö ‰∏ä‰∏ÄÈ°µ</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">‰∏ã‰∏ÄÈ°µ ‚û°</button>
    </div>
  </main>

  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">ÂÖ≥Èó≠ ‚úñ</button>
      <h3>Êî∂ÊçÆËØ¶ÊÉÖ</h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <div id="loadingOverlay">
    <div>
      <div class="spinner"></div>
      <span>Ê≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂÄô...</span>
    </div>
  </div>

  <script>
    const API_URL = "https://syve-dinvoice-system.vercel.app/api/salesreceipt";
    let allRecords = [], uniqueRows = [];
    let currentPage = 1, rowsPerPage = 20, filteredRows = [];

    function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
    function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }
    function sendBack() { window.location.href = 'main.html'; }

    async function fetchAllReceipts() {
      showLoading();
      try {
        const res = await fetch(API_URL);
        let records = await res.json();
        records.forEach(r => { if (!r.fields["Status"]) r.fields["Status"] = "Active"; });
        return records;
      } finally { hideLoading(); }
    }

    function renderTable(page = 1) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredRows.slice(start, end);

      pageData.forEach(rec => {
        const f = rec.fields;
        const no = f["Receipt Number"] || "‚Äî";
        const name = f["Customer Name"] || "‚Äî";
        const time = f["Time Stamp"] ? new Date(f["Time Stamp"]).toLocaleString("zh-MY") : "‚Äî";
        const sameReceiptRows = allRecords.filter(r => r.fields["Receipt Number"] === no);
        let totalAmount = 0;
        sameReceiptRows.forEach(r => {
          const w = parseFloat(r.fields["Weight"]) || 0;
          const p = parseFloat(r.fields["Unit Price"]) || 0;
          totalAmount += w * p;
        });
        const status = f["Status"] || "Active";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${no}</td>
          <td>${name}</td>
          <td>${time}</td>
          <td>${totalAmount.toFixed(2)}</td>
          <td></td>
        `;

        const td = tr.querySelector("td:last-child");
        if (status === "Cancelled") {
          td.innerHTML = "<span style='color:red;font-weight:bold'>Â∑≤ÂèñÊ∂à</span>";
        } else {
          const btnView = document.createElement("button");
          btnView.textContent = "üëÅÔ∏è Êü•Áúã";
          btnView.onclick = () => viewOne(no);

          const btnPrint = document.createElement("button");
          btnPrint.textContent = "üñ®Ô∏è ÊâìÂç∞";
          btnPrint.onclick = () => printOne(no);

          const btnCancel = document.createElement("button");
          btnCancel.textContent = "‚ùå ÂèñÊ∂à";
          btnCancel.onclick = () => cancelReceipt(rec.id, no);

          td.append(btnView, btnPrint, btnCancel);
        }

        tbody.appendChild(tr);
      });

      document.getElementById("pageInfo").textContent =
        `Á¨¨ ${currentPage} È°µ / ÂÖ± ${Math.ceil(filteredRows.length / rowsPerPage)} È°µÔºàÂÖ± ${filteredRows.length} Êù°ËÆ∞ÂΩïÔºâ`;
    }

    function viewOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("Êâæ‰∏çÂà∞ËØ•Êî∂ÊçÆ");
      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");
      let itemsHTML = "";
      let tot = 0;
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
        itemsHTML += `<tr><td>${product}</td><td>${weight.toFixed(2)} kg</td><td>RM ${price.toFixed(2)}</td><td>RM ${subtotal.toFixed(2)}</td></tr>`;
      });
      document.getElementById("modalBody").innerHTML = `
        <p><strong>ÂÆ¢Êà∑Ôºö</strong>${cust}</p>
        <p><strong>ÁºñÂè∑Ôºö</strong>${receiptNo}</p>
        <p><strong>Êó∂Èó¥Ôºö</strong>${timeStr}</p>
        <table>
          <thead><tr><th>‰∫ßÂìÅ</th><th>ÈáçÈáè</th><th>Âçï‰ª∑</th><th>Â∞èËÆ°</th></tr></thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot><tr><td colspan="3"><strong>ÊÄªËÆ°</strong></td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
        </table>
      `;
      document.getElementById("receiptModal").style.display = "flex";
    }

    function closeModal() { document.getElementById("receiptModal").style.display = "none"; }

    async function cancelReceipt(recordId, receiptNo) {
      if (!confirm(`Á°ÆÂÆöË¶ÅÂèñÊ∂àÊî∂ÊçÆ ${receiptNo} ÂêóÔºü`)) return;
      showLoading();
      try {
        const payload = { recordId, status: "Cancelled" };
        const res = await fetch("https://syve-dinvoice-system.vercel.app/api/updateSaleStatus", {
          method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          alert("‚úÖ Êî∂ÊçÆÂ∑≤ÂèñÊ∂àÔºÅ");
          const rec = allRecords.find(r => r.id === recordId);
          if (rec) rec.fields["Status"] = "Cancelled";
          renderTable(currentPage);
        } else {
          alert("‚ùå ÂèñÊ∂àÂ§±Ë¥•: " + (result.error?.message || "Êú™Áü•ÈîôËØØ"));
        }
      } catch { alert("‚ùå ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïÂèñÊ∂àÊî∂ÊçÆ"); }
      finally { hideLoading(); }
    }

    function filterTable() {
      const kw = document.getElementById("searchBar").value.toLowerCase();
      filteredRows = uniqueRows.filter(r => {
        const f = r.fields;
        const no = (f["Receipt Number"] || "").toLowerCase();
        const name = (f["Customer Name"] || "").toLowerCase();
        let totalAmount = 0;
        allRecords.filter(row => row.fields["Receipt Number"] === f["Receipt Number"])
          .forEach(row => {
            const w = parseFloat(row.fields["Weight"]) || 0;
            const p = parseFloat(row.fields["Unit Price"]) || 0;
            totalAmount += w * p;
          });
        const amountStr = totalAmount.toFixed(2);
        const dateObj = f["Time Stamp"] ? new Date(f["Time Stamp"]) : null;
        const timeStr = dateObj ? dateObj.toLocaleString("zh-MY") : "";
        const isoStr = dateObj ? dateObj.toISOString().split("T")[0] : "";
        return no.includes(kw) || name.includes(kw) || amountStr.includes(kw)
          || timeStr.toLowerCase().includes(kw) || isoStr.includes(kw);
      });
      currentPage = 1;
      renderTable();
    }

    function prevPage() { if (currentPage > 1) { currentPage--; renderTable(currentPage); } }
    function nextPage() { if (currentPage < Math.ceil(filteredRows.length / rowsPerPage)) { currentPage++; renderTable(currentPage); } }

    function printOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("Invoice not found");
    
      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");
      let tot = 0, itemsHTML = "";
    
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
        itemsHTML += `<tr>
          <td>${product}</td>
          <td>${weight.toFixed(2)} kg</td>
          <td>RM ${price.toFixed(2)}</td>
          <td>RM ${subtotal.toFixed(2)}</td>
        </tr>`;
      });
    
      const win = window.open("", "_blank");
      win.document.write(`
        <html>
          <head>
            <meta charset="UTF-8"/>
            <title>Invoice ${receiptNo}</title>
            <style id="printStyle">
              @page { size: A4 portrait; margin: 15mm; }
              body { font-family: Arial, sans-serif; font-size: 12pt; padding: 20px; color: #2c3e50; }
              .header { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 15px; }
              table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              th, td { border: 1px solid #000; padding: 6px; text-align: center; }
              tfoot td { font-weight: bold; background: #f9f9f9; }
              .footer { text-align: center; margin-top: 20px; }
              .no-print {
                text-align: center;
                margin-top: 20px;
                display: flex;
                justify-content: center;
                gap: 15px;
              }
              .no-print .btn {
                flex: 0 0 120px;
                padding: 10px 0;
                font-size: 12pt;
                border: none;
                border-radius: 8px;
                background: linear-gradient(135deg, #3498db, #2c80b4);
                color: #fff;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                transition: all 0.25s ease;
              }
              .no-print .btn:hover {
                background: linear-gradient(135deg, #2c80b4, #246a91);
                transform: translateY(-2px);
              }
              @media print { .no-print { display: none !important; } }
            </style>
          </head>
          <body>
            <div class="header">Sales Invoice</div>
            <p><b>ÂÆ¢Êà∑:</b> ${cust}</p>
            <p><b>Êî∂ÊçÆÁºñÂè∑:</b> ${receiptNo}</p>
            <p><b>Êó∂Èó¥:</b> ${timeStr}</p>
            <table>
              <thead><tr><th>‰∫ßÂìÅ</th><th>ÈáçÈáè</th><th>Âçï‰ª∑</th><th>Â∞èËÆ°</th></tr></thead>
              <tbody>${itemsHTML}</tbody>
              <tfoot><tr><td colspan="3">ÊÄªËÆ°</td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
            </table>
            <div class="footer">‚ùÄ Thank You ‚ùÄ</div>
            <div class="no-print">
              <button class="btn" onclick="setPaper('a4')">üñ® ÊâìÂç∞ A4</button>
              <button class="btn" onclick="setPaper('receipt')">üßæ ÊâìÂç∞Â∞èÁ•®</button>
              <button class="btn" onclick="window.close()">‚¨Ö ËøîÂõû</button>
            </div>
            <script>
              function setPaper(type) {
                var style = document.getElementById("printStyle");
                if (type === "a4") {
                  style.innerHTML = \`
                    @page { size: A4 portrait; margin: 15mm; }
                    body { font-family: Arial; font-size: 12pt; padding: 20px; }
                    .header { text-align:center; font-size:18pt; font-weight:bold; margin-bottom:15px; }
                    table { width:100%; border-collapse:collapse; margin-top:10px; }
                    th,td { border:1px solid #000; padding:6px; text-align:center; }
                    tfoot td { font-weight:bold; background:#f9f9f9; }
                    @media print { .no-print { display:none !important; } }
                  \`;
                } else {
                  style.innerHTML = \`
                    @page { size: 48mm auto; margin: 0; }
                    body { display:flex; justify-content:center; margin:0; padding:0; }
                    .ticket {
                      width:48mm;
                      font-family: monospace,Arial;
                      font-size:10pt;
                      padding:2mm;
                      box-sizing:border-box;
                    }
                    .header { text-align:center; font-size:12pt; font-weight:bold; margin-bottom:10px; }
                    table { width:100%; font-size:9pt; border-collapse:collapse; }
                    th,td { border:none; text-align:left; padding:2px 0; }
                    tfoot td { border-top:1px dashed #000; font-weight:bold; }
                    @media print { .no-print { display:none !important; } }
                  \`;
                  document.body.innerHTML = '<div class="ticket">' + document.body.innerHTML + '</div>';
                }
                window.print();
              }
            <\/script>
          </body>
        </html>
      `);
      win.document.close();
    }

    fetchAllReceipts().then(records => {
      allRecords = records;
      const seen = new Set();
      records.forEach(r => {
        const n = r.fields["Receipt Number"];
        if (!seen.has(n)) { uniqueRows.push(r); seen.add(n); }
      });
      filteredRows = uniqueRows;
      renderTable();
    });
  </script>
</body>
</html>
