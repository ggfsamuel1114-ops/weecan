


<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <title>History Center - Sales Receipts</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: center; }
    button { padding: 6px 12px; border: none; background: #d9ecf2; cursor: pointer; border-radius: 8px; }
    button:hover { background: #b9d9e7; }
    #searchBar { padding: 8px; font-size: 16px; width: 100%; max-width: 400px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; }
    .pagination { margin-top: 15px; }
    .pagination button { margin: 0 5px; }

    /* 模态弹窗 */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .modal-content th, .modal-content td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .modal-close {
      background: #e74c3c; color: white;
      border: none; padding: 6px 12px;
      border-radius: 6px; cursor: pointer;
      float: right;
    }
  </style>
</head>
<body>
  <h2>Sales History</h2>
  <button onclick="sendBack()">🔙 返回首页</button>
  <input type="text" id="searchBar" placeholder="🔍 搜索收据编号、客户名、金额或日期..." oninput="filterTable()" />

  <table id="historyTable">
    <thead>
      <tr>
        <th>收据编号</th>
        <th>客户</th>
        <th>时间</th>
        <th>金额 (RM)</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">⬅ 上一页</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">下一页 ➡</button>
  </div>

  <!-- 模态弹窗 -->
  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">关闭 ✖</button>
      <h3>收据详情</h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://weecan-airtable-api.vercel.app/api/salesreceipt";
    
    let allRecords = [], uniqueRows = [];
    let currentPage = 1, rowsPerPage = 20, filteredRows = [];

    async function fetchAllReceipts() {
      const res = await fetch(API_URL);
      return await res.json();
    }

    function sendBack() {
      window.location.href = 'main.html';
    }
    
    function renderTable(page = 1) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredRows.slice(start, end);

      pageData.forEach(rec => {
        const f = rec.fields;
        const no = f["Receipt Number"] || "—";
        const name = f["Customer Name"] || "—";
        const time = f["Time Stamp"] ? new Date(f["Time Stamp"]).toLocaleString("zh-MY") : "—";

        const sameReceiptRows = allRecords.filter(r => r.fields["Receipt Number"] === no);
        let totalAmount = 0;
        sameReceiptRows.forEach(r => {
          const w = parseFloat(r.fields["Weight"]) || 0;
          const p = parseFloat(r.fields["Unit Price"]) || 0;
          totalAmount += w * p;
        });

        tbody.insertAdjacentHTML(
          "beforeend",
          `<tr>
            <td>${no}</td>
            <td>${name}</td>
            <td>${time}</td>
            <td>${totalAmount.toFixed(2)}</td>
            <td>
              <button onclick="viewOne('${no}')">👁️ 查看</button>
              <button onclick="printOne('${no}')">🖨️ 打印</button>
            </td>
          </tr>`
        );
      });

      document.getElementById("pageInfo").textContent =
        `第 ${currentPage} 页 / 共 ${Math.ceil(filteredRows.length / rowsPerPage)} 页（共 ${filteredRows.length} 条记录）`;
    }

    // 模态查看
    function viewOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("找不到该收据");

      const cust = rows[0].fields["Customer Name"] || "N/A";
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");

      let itemsHTML = "";
      let tot = 0;
      rows.forEach(r => {
        const product = r.fields["Product Name"] || "";
        const weight = parseFloat(r.fields["Weight"]) || 0;
        const price = parseFloat(r.fields["Unit Price"]) || 0;
        const subtotal = weight * price;
        tot += subtotal;
        itemsHTML += `
          <tr>
            <td>${product}</td>
            <td>${weight.toFixed(2)} kg</td>
            <td>RM ${price.toFixed(2)}</td>
            <td>RM ${subtotal.toFixed(2)}</td>
          </tr>`;
      });

      document.getElementById("modalBody").innerHTML = `
        <p><strong>客户：</strong>${cust}</p>
        <p><strong>编号：</strong>${receiptNo}</p>
        <p><strong>时间：</strong>${timeStr}</p>
        <table>
          <thead><tr><th>产品</th><th>重量</th><th>单价</th><th>小计</th></tr></thead>
          <tbody>${itemsHTML}</tbody>
          <tfoot><tr><td colspan="3"><strong>总计</strong></td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
        </table>
      `;

      document.getElementById("receiptModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("receiptModal").style.display = "none";
    }

    // 判断是否 iOS
    function isIOS() {
      return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // 打印（iOS: window.open, Android: iframe）
    function printOne(receiptNo) {
      const rows = allRecords.filter(r => r.fields["Receipt Number"] === receiptNo);
      if (!rows.length) return alert("找不到该收据");

      const cust = rows[0].fields["Customer Name"] || "N/A";
      const no = receiptNo;
      const timeStr = new Date(rows[0].fields["Time Stamp"]).toLocaleString("zh-MY");

      let tot = 0, itemsHTML = "";
      rows.forEach(r => {
        const w = parseFloat(r.fields["Weight"]) || 0;
        const p = parseFloat(r.fields["Unit Price"]) || 0;
        const s = w * p;
        tot += s;
        itemsHTML += `<tr><td>${r.fields["Product Name"]||""}</td><td>${w.toFixed(2)}</td><td>RM ${p.toFixed(2)}</td><td>RM ${s.toFixed(2)}</td></tr>`;
      });

      const htmlContent = `
        <html><head><meta charset="UTF-8"/>
        <style>
          body { font-family: Arial; font-size: 12pt; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #000; padding: 6px; text-align: center; }
          tfoot td { font-weight: bold; background: #f5f5f5; }
        </style></head>
        <body>
          <h2 style="text-align:center"></h2>
          <p><b>客户：</b>${cust}</p>
          <p><b>编号：</b>${no}</p>
          <p><b>时间：</b>${timeStr}</p>
          <table>
            <thead><tr><th>产品</th><th>重量</th><th>单价</th><th>总价</th></tr></thead>
            <tbody>${itemsHTML}</tbody>
            <tfoot><tr><td colspan="3">总计</td><td>RM ${tot.toFixed(2)}</td></tr></tfoot>
          </table>
          <div style="text-align:center;margin-top:10px">❀ Thank You ❀</div>
        </body></html>`;

      if (isIOS()) {
        // iOS 用 window.open
        const printWin = window.open('', '_blank');
        printWin.document.open();
        printWin.document.write(htmlContent);
        printWin.document.close();
        printWin.focus();
        printWin.print();
        printWin.close();
      } else {
        // Android/其他用 iframe
        const iframe = document.createElement("iframe");
        iframe.style.position = "absolute";
        iframe.style.left = "-9999px";
        document.body.appendChild(iframe);

        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(htmlContent);
        doc.close();

        iframe.contentWindow.focus();
        iframe.contentWindow.print();

        setTimeout(() => document.body.removeChild(iframe), 1000);
      }
    }

    // 搜索过滤（支持 YYYY-MM-DD）
    function filterTable() {
      const kw = document.getElementById("searchBar").value.toLowerCase();
      filteredRows = uniqueRows.filter(r => {
        const f = r.fields;
        const no = (f["Receipt Number"] || "").toLowerCase();
        const name = (f["Customer Name"] || "").toLowerCase();
    
        // 金额
        let totalAmount = 0;
        allRecords.filter(row => row.fields["Receipt Number"] === f["Receipt Number"])
          .forEach(row => {
            const w = parseFloat(row.fields["Weight"]) || 0;
            const p = parseFloat(row.fields["Unit Price"]) || 0;
            totalAmount += w * p;
          });
        const amountStr = totalAmount.toFixed(2);
    
        // 时间
        const dateObj = f["Time Stamp"] ? new Date(f["Time Stamp"]) : null;
        const timeStr = dateObj ? dateObj.toLocaleString("zh-MY") : "";
        const isoStr = dateObj ? dateObj.toISOString().split("T")[0] : ""; // YYYY-MM-DD
    
        return no.includes(kw) || name.includes(kw) || amountStr.includes(kw)
          || timeStr.toLowerCase().includes(kw) || isoStr.includes(kw);
      });
      currentPage = 1;
      renderTable();
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable(currentPage);
      }
    }

    function nextPage() {
      if (currentPage < Math.ceil(filteredRows.length / rowsPerPage)) {
        currentPage++;
        renderTable(currentPage);
      }
    }

    // 初始化
    fetchAllReceipts().then(records => {
      allRecords = records;
      const seen = new Set();
      records.forEach(r => {
        const n = r.fields["Receipt Number"];
        if (!seen.has(n)) {
          uniqueRows.push(r);
          seen.add(n);
        }
      });
      filteredRows = uniqueRows;
      renderTable();
    });
  </script>
</body>
</html>
